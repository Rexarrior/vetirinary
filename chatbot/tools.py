"""
Custom tools for the veterinary clinic AI assistant.
"""

from langchain.tools import tool
from duckduckgo_search import DDGS


@tool
def get_clinic_info() -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω–æ–π –∫–ª–∏–Ω–∏–∫–µ: –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, email, —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã.
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö, 
    –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–µ —Ä–∞–±–æ—Ç—ã –∫–ª–∏–Ω–∏–∫–∏.
    """
    from contacts.models import ContactInfo
    
    try:
        contact = ContactInfo.objects.first()
        if contact:
            return f"""
–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–Ω–∏–∫–µ:
- –ù–∞–∑–≤–∞–Ω–∏–µ: {contact.clinic_name}
- –ê–¥—Ä–µ—Å: {contact.address}
- –¢–µ–ª–µ—Ñ–æ–Ω: {contact.phone}
- Email: {contact.email}
- –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: {contact.working_hours}
- –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å: –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É {contact.phone}
"""
        return "–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    except Exception as e:
        return f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: {str(e)}"


@tool
def get_services_list() -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –∏ —Ü–µ–Ω –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω–æ–π –∫–ª–∏–Ω–∏–∫–∏.
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± —É—Å–ª—É–≥–∞—Ö, 
    –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö –∏–ª–∏ —Ü–µ–Ω–∞—Ö –∫–ª–∏–Ω–∏–∫–∏.
    """
    from services.models import ServiceCategory, Service
    
    try:
        categories = ServiceCategory.objects.filter(is_active=True).prefetch_related('services')
        
        if not categories.exists():
            return "–°–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
        
        result = "–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã –Ω–∞—à–µ–π –∫–ª–∏–Ω–∏–∫–∏:\n\n"
        
        for category in categories:
            services = category.services.filter(is_active=True)[:5]  # Limit to 5 per category
            if services:
                result += f"üìã {category.name}:\n"
                for service in services:
                    price_str = f"{service.price} —Ä—É–±."
                    if service.price_note:
                        price_str = f"{service.price_note} {price_str}"
                    result += f"  ‚Ä¢ {service.name} ‚Äî {price_str}\n"
                result += "\n"
        
        result += "–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥ –ø–æ—Å–µ—Ç–∏—Ç–µ —Ä–∞–∑–¥–µ–ª '–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã' –Ω–∞ –Ω–∞—à–µ–º —Å–∞–π—Ç–µ."
        return result
    except Exception as e:
        return f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥: {str(e)}"


@tool
def get_veterinarians() -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∞—Ö –∫–ª–∏–Ω–∏–∫–∏.
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –≤—Ä–∞—á–∞—Ö, 
    —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞—Ö –∏–ª–∏ –∫–æ–º–∞–Ω–¥–µ –∫–ª–∏–Ω–∏–∫–∏.
    """
    from about.models import Veterinarian
    
    try:
        vets = Veterinarian.objects.filter(is_active=True)
        
        if not vets.exists():
            return "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–∞—á–∞—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞."
        
        result = "–ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã:\n\n"
        
        for vet in vets:
            result += f"üë®‚Äç‚öïÔ∏è {vet.name}\n"
            result += f"   –î–æ–ª–∂–Ω–æ—Å—Ç—å: {vet.position}\n"
            if vet.bio:
                # Truncate bio to 150 chars
                bio = vet.bio[:150] + "..." if len(vet.bio) > 150 else vet.bio
                result += f"   {bio}\n"
            result += "\n"
        
        return result
    except Exception as e:
        return f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–∞—á–∞—Ö: {str(e)}"


@tool
def search_veterinary_info(query: str) -> str:
    """
    –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—ã–º —Ç–µ–º–∞–º –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¢–û–õ–¨–ö–û –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –∑–¥–æ—Ä–æ–≤—å–µ –∂–∏–≤–æ—Ç–Ω—ã—Ö, 
    –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∏–∏, —É—Ö–æ–¥–µ –∑–∞ –ø–∏—Ç–æ–º—Ü–∞–º–∏.
    –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Ç–µ–º, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∂–∏–≤–æ—Ç–Ω—ã–º–∏.
    
    Args:
        query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—É—é —Ç–µ–º—É
    """
    # List of veterinary-related keywords to validate query
    vet_keywords = [
        '—Å–æ–±–∞–∫–∞', '–∫–æ—à–∫–∞', '–ø–∏—Ç–æ–º–µ—Ü', '–∂–∏–≤–æ—Ç–Ω', '–≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä', '–ª–µ—á–µ–Ω', '–±–æ–ª–µ–∑–Ω',
        '—Å–∏–º–ø—Ç–æ–º', '–≤–∞–∫—Ü–∏–Ω', '–ø—Ä–∏–≤–∏–≤–∫', '–∫–æ—Ä–º', '—É—Ö–æ–¥', '–ø–æ—Ä–æ–¥–∞', '—â–µ–Ω–æ–∫', '–∫–æ—Ç—ë–Ω–æ–∫',
        '–∫–æ—Ç–µ–Ω–æ–∫', '—Ö–æ–º—è–∫', '–ø–æ–ø—É–≥–∞–π', '–∫—Ä–æ–ª–∏–∫', '–≥—Ä—ã–∑—É–Ω', '—Ä–µ–ø—Ç–∏–ª–∏', '—Ä—ã–±–∫',
        '–∞–∫–≤–∞—Ä–∏—É–º', '–ø—Ç–∏—Ü', '–ª–æ—à–∞–¥', '–∑–¥–æ—Ä–æ–≤—å', 'dog', 'cat', 'pet', 'vet',
        '—Ö–≤–æ—Å—Ç', '–ª–∞–ø', '—à–µ—Ä—Å—Ç', '–∫–ª–µ—â', '–±–ª–æ—Ö', '–≥–ª–∏—Å—Ç', '–ø–∞—Ä–∞–∑–∏—Ç', '—Å—Ç–µ—Ä–∏–ª–∏–∑',
        '–∫–∞—Å—Ç—Ä–∞—Ü', '–æ–ø–µ—Ä–∞—Ü', '—Ç—Ä–∞–≤–º', '–ø–µ—Ä–µ–ª–æ–º', '—Ä–∞–Ω–∞', '–∏–Ω—Ñ–µ–∫—Ü', '–≤–∏—Ä—É—Å',
        '–ø–æ–Ω–æ—Å', '—Ä–≤–æ—Ç', '–∞–ø–ø–µ—Ç–∏—Ç', '—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä', '–∫–∞—à–µ–ª', '—á–∏—Ö–∞–Ω'
    ]
    
    query_lower = query.lower()
    is_vet_related = any(keyword in query_lower for keyword in vet_keywords)
    
    if not is_vet_related:
        return """–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –º–æ–≥—É –∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –ø–æ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—ã–º —Ç–µ–º–∞–º. 
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –∑–¥–æ—Ä–æ–≤—å–µ –∂–∏–≤–æ—Ç–Ω—ã—Ö, —É—Ö–æ–¥–µ –∑–∞ –ø–∏—Ç–æ–º—Ü–∞–º–∏ –∏–ª–∏ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∏–∏."""
    
    try:
        # Add veterinary context to the query
        search_query = f"{query} –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–∏—è"
        
        with DDGS() as ddgs:
            results = list(ddgs.text(search_query, max_results=3))
        
        if not results:
            return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É."
        
        response = "üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:\n\n"
        response += "‚ö†Ô∏è –í–ê–ñ–ù–û: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω–æ—Å–∏—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. "
        response += "–î–ª—è —Ç–æ—á–Ω–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞ –∏ –ª–µ—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä—É!\n\n"
        
        for i, result in enumerate(results, 1):
            title = result.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
            body = result.get('body', '')
            link = result.get('href', '')
            
            # Truncate body
            if len(body) > 200:
                body = body[:200] + "..."
            
            response += f"{i}. **{title}**\n"
            response += f"   {body}\n"
            if link:
                response += f"   –ò—Å—Ç–æ—á–Ω–∏–∫: {link}\n"
            response += "\n"
        
        response += "---\n"
        response += "–ü–æ–º–Ω–∏—Ç–µ: –ø—Ä–∏ –ª—é–±—ã—Ö —Ç—Ä–µ–≤–æ–∂–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–∞—Ö —É –≤–∞—à–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞ –ª—É—á—à–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä—É –ª–∏—á–Ω–æ!"
        
        return response
        
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: {str(e)}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å."

