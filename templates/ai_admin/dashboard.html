{% extends 'admin/base_site.html' %}
{% load static %}

{% block title %}AI Admin Dashboard | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
    :root {
        --primary-color: #4f46e5;
        --secondary-color: #1e293b;
        --accent-color: #0ea5e9;
        --bg-dark: #0f172a;
        --bg-card: #1e293b;
        --text-light: #f8fafc;
        --text-muted: #94a3b8;
        --border-color: #334155;
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-light);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    #header {
        background-color: var(--secondary-color);
        border-bottom: 1px solid var(--border-color);
    }

    .dashboard-container {
        display: flex;
        height: calc(100vh - 60px);
        /* Adjust based on admin header height */
        overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
        width: 350px;
        background-color: var(--bg-card);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .task-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .task-item {
        padding: 15px;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.03);
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .task-item:hover,
    .task-item.active {
        background-color: rgba(79, 70, 229, 0.1);
        border-color: var(--primary-color);
    }

    .task-status {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 12px;
        text-transform: uppercase;
        font-weight: 600;
    }

    .status-pending {
        background-color: #f59e0b20;
        color: #f59e0b;
    }

    .status-analyzing {
        background-color: #3b82f620;
        color: #3b82f6;
    }

    .status-executing {
        background-color: #8b5cf620;
        color: #8b5cf6;
    }

    .status-completed {
        background-color: #10b98120;
        color: #10b981;
    }

    .status-failed {
        background-color: #ef444420;
        color: #ef4444;
    }

    /* Main Chat Area */
    .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: var(--bg-dark);
        position: relative;
    }

    .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .message {
        max-width: 80%;
        padding: 15px 20px;
        border-radius: 12px;
        line-height: 1.5;
        position: relative;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        align-self: flex-end;
        background-color: var(--primary-color);
        color: white;
        border-bottom-right-radius: 2px;
    }

    .message.agent {
        align-self: flex-start;
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 2px;
    }

    .input-area {
        padding: 20px;
        background-color: var(--bg-card);
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 10px;
    }

    .chat-input {
        flex: 1;
        background-color: var(--bg-dark);
        border: 1px solid var(--border-color);
        color: var(--text-light);
        padding: 12px 20px;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.2s;
    }

    .chat-input:focus {
        border-color: var(--primary-color);
    }

    .send-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
    }

    .send-btn:hover {
        background-color: #4338ca;
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: var(--bg-card);
        width: 90%;
        max-width: 1000px;
        height: 85vh;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 0;
    }

    .modal-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }

    .close-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.5rem;
        cursor: pointer;
    }

    .close-btn:hover {
        color: var(--text-light);
    }

    /* Loading Indicator */
    .typing-indicator {
        display: flex;
        gap: 5px;
        padding: 10px;
        align-self: flex-start;
    }

    .dot {
        width: 8px;
        height: 8px;
        background-color: var(--text-muted);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="margin: 0; font-size: 1.2rem; color: var(--text-light);">Task History</h2>
            <button class="btn btn-sm btn-outline-light" onclick="startNewChat()">
                <i class="bi bi-plus-lg"></i> New
            </button>
        </div>
        <div class="task-list" id="taskList">
            <!-- Tasks will be loaded here -->
        </div>
    </div>

    <div class="main-area">
        <div class="chat-container" id="chatContainer">
            <div class="message agent">
                Hello! I am your AI Admin Assistant. How can I help you manage the clinic today?
            </div>
        </div>
        <div class="input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your request here..."
                onkeypress="handleKeyPress(event)">
            <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                <i class="bi bi-send"></i> Send
            </button>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="reportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin: 0;">Task Report</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="reportContent" style="height: 100%; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<script>
    let currentTaskId = null;
    let pollingInterval = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadTasks();
    });

    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    async function loadTasks() {
        try {
            const response = await fetch('{% url "ai_admin:api_task_list" %}');
            const data = await response.json();
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';

            data.tasks.forEach(task => {
                const div = document.createElement('div');
                div.className = `task-item ${currentTaskId === task.id ? 'active' : ''}`;
                div.onclick = () => loadTaskDetails(task);

                const date = new Date(task.created_at).toLocaleDateString();
                const statusClass = `status-${task.status.toLowerCase()}`;

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span class="task-status ${statusClass}">${task.status}</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">${date}</span>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${task.user_request}
                    </div>
                `;
                taskList.appendChild(div);
            });
        } catch (error) {
            console.error('Error loading tasks:', error);
        }
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        // Add user message to chat
        addMessage(message, 'user');
        input.value = '';
        input.disabled = true;
        document.getElementById('sendBtn').disabled = true;

        // Add loading indicator
        addLoadingIndicator();

        try {
            const response = await fetch('{% url "ai_admin:api_chat" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            currentTaskId = data.id;
            startPolling(currentTaskId);
            loadTasks(); // Refresh list

        } catch (error) {
            removeLoadingIndicator();
            addMessage(`Error: ${error.message}`, 'agent');
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
        }
    }

    function addMessage(text, type) {
        const container = document.getElementById('chatContainer');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.textContent = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addLoadingIndicator() {
        const container = document.getElementById('chatContainer');
        const div = document.createElement('div');
        div.className = 'typing-indicator';
        div.id = 'loadingIndicator';
        div.innerHTML = `
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function removeLoadingIndicator() {
        const indicator = document.getElementById('loadingIndicator');
        if (indicator) indicator.remove();
    }

    function startPolling(taskId) {
        if (pollingInterval) clearInterval(pollingInterval);

        pollingInterval = setInterval(async () => {
            try {
                const response = await fetch(`/ai-admin/task/${taskId}/status/`);
                const data = await response.json();

                // Update status in sidebar
                loadTasks();

                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(pollingInterval);
                    removeLoadingIndicator();

                    if (data.status === 'completed') {
                        let responseText = data.result_summary || "Task completed successfully.";
                        addMessage(responseText, 'agent');

                        // Add button to view report
                        const btnDiv = document.createElement('div');
                        btnDiv.className = 'message agent';
                        btnDiv.style.cursor = 'pointer';
                        btnDiv.style.textDecoration = 'underline';
                        btnDiv.innerHTML = `<i class="bi bi-file-earmark-text"></i> View Detailed Report`;
                        btnDiv.onclick = () => openReport(taskId);
                        document.getElementById('chatContainer').appendChild(btnDiv);
                    } else {
                        addMessage(`Task failed: ${data.error_message}`, 'agent');
                    }

                    document.getElementById('chatInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }, 2000);
    }

    function loadTaskDetails(task) {
        currentTaskId = task.id;
        const container = document.getElementById('chatContainer');
        container.innerHTML = ''; // Clear current chat

        // Reconstruct chat history (simplified for now)
        addMessage(task.user_request, 'user');

        if (task.status === 'completed') {
            addMessage(task.result_summary || "Task completed.", 'agent');

            const btnDiv = document.createElement('div');
            btnDiv.className = 'message agent';
            btnDiv.style.cursor = 'pointer';
            btnDiv.style.textDecoration = 'underline';
            btnDiv.innerHTML = `<i class="bi bi-file-earmark-text"></i> View Detailed Report`;
            btnDiv.onclick = () => openReport(task.id);
            container.appendChild(btnDiv);
        } else if (task.status === 'failed') {
            addMessage(`Task failed: ${task.error_message}`, 'agent');
        } else {
            addMessage(`Task is currently ${task.status}...`, 'agent');
            startPolling(task.id);
        }
    }

    function startNewChat() {
        currentTaskId = null;
        if (pollingInterval) clearInterval(pollingInterval);
        document.getElementById('chatContainer').innerHTML = `
            <div class="message agent">
                Hello! I am your AI Admin Assistant. How can I help you manage the clinic today?
            </div>
        `;
        document.getElementById('chatInput').value = '';
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;

        // Deselect tasks in sidebar
        document.querySelectorAll('.task-item').forEach(el => el.classList.remove('active'));
    }

    async function openReport(taskId) {
        try {
            const response = await fetch(`/ai-admin/task/${taskId}/status/`);
            const data = await response.json();

            if (data.report_slug) {
                const reportResponse = await fetch(`/ai-admin/report/${data.report_slug}/`);
                if (!reportResponse.ok) throw new Error('Failed to load report');

                const reportHtml = await reportResponse.text();
                const container = document.getElementById('reportContent');
                container.innerHTML = reportHtml;

                document.getElementById('reportModal').style.display = 'flex';
            } else {
                alert('Report not generated yet.');
            }
        } catch (error) {
            console.error('Error opening report:', error);
            alert('Failed to load report. See console for details.');
        }
    }

    function closeModal() {
        document.getElementById('reportModal').style.display = 'none';
        document.getElementById('reportContent').innerHTML = '';
    }
</script>
{% endblock %}